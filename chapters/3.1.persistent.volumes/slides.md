---
# try also 'default' to start simple
theme: seriph
# random image from a curated Unsplash collection by Anthony
# like them? see https://unsplash.com/collections/94734566/slidev
background: https://source.unsplash.com/collection/94734566/1920x1080
# apply any windi css classes to the current slide
class: 'text-center'
# https://sli.dev/custom/highlighters.html
highlighter: shiki
# show line numbers in code blocks
lineNumbers: false
# some information about the slides, markdown enabled
info: |
  ## Slidev Starter Template
  Presentation slides for developers.

  Learn more at [Sli.dev](https://sli.dev)

layout: cover
# persist drawings in exports and build
drawings:
  persist: true
---

# 3.1. Persistent Volumes

---

# 3.1. Persistent Volumes

The PersistentVolume subsystem provides an API for users and administrators that abstracts details of how storage is provided from how it is consumed

To do this we introduce two new API resources

**PersistentVolumeClaim** (PVC): is a request for storage by a user.

**PersistentVolume** (PV): is a piece of networked storage in the cluster that has been provisioned by an administrator.

**StorageClass** provides a way for administrators to describe the “classes” of storage they offer.

---

# Persistent Volume Claim

* This is a PersistentVolumeClaim:

    ```yaml
    kind: PersistentVolumeClaim
    apiVersion: v1
    metadata:
      name: myclaim-1
      labels:
        temporal: "true"
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 2Gi
    ```

* Let's create it:

    ```shell
    $ kubectl create -f 09.myclaim-pvc/
    ```

---

# Persistent Volume

If you check your Persistent Volumes now, you'll see there is already a PV generated and bound to the PVC.

* This is how it looks (`-o yaml` means output in yaml format):

    ```shell
    $ kubectl get persistentvolume -o yaml
    kind: PersistentVolume
    apiVersion: v1
    metadata:
      name: pvc-ded278e1-08f3-11e7-8842-0800276b3654
      annotations:
        volume.beta.kubernetes.io/storage-class: standard
    spec:
      capacity:
        storage: 2Gi
      accessModes:
        - ReadWriteOnce
        hostPath:
          path: /tmp/hostpath-provisioner/pvc-ded278e1-08f3-11e7-8842-0800276b3654
      persistentVolumeReclaimPolicy: "Delete"
    ```

---

# Storage Class

* The PV was generated by an existing Storage Class in minikube.

    ```shell
    $ kubectl get storageclass
    NAME                 PROVISIONER                AGE
    standard (default)   k8s.io/minikube-hostpath   4d
    ```

In this case minikube uses Host paths inside the `/tmp/` directory and provides them as storage to the claims.

There are other implementations:

* AWS uses EBS volumes as storage
* GCE uses PD volumes as storage
* etc

But the PVC is the same as it is abstracted from the storage provider.

* Let's delete the PersistentVolumeClaim:

    ```shell
    $ kubectl delete persistentvolumeclaim myclaim-1
    ```

---

# Ghost

* As an example we'll deploy Ghost

    ```yaml
    ...
    spec:
      replicas: 1
      template:
        metadata:
          ...
        spec:
          containers:
          - image: ghost:0.10
            name: ghost
            ...
            volumeMounts:
                - name: ghost
                  mountPath: /var/lib/ghost
                  subPath: "ghost"
          volumes:
            - name: ghost
              persistentVolumeClaim:
                claimName: ghost-claim
    ```
---

# Ghost

* Let's deploy it:

    ```shell
    $ kubectl create -f 10.ghost/
    ```

* Ghost's Items

    ```shell
    $ kubectl get pvc,pv,pod,svc
    ```

* Let's delete it:

    ```shell
    $ kubectl delete -f 10.ghost/
    ```
